<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <style>
        :root { --primary: #3498db; --success: #27ae60; --warning: #f39c12; --error: #e74c3c; --bg: #f4f6f8; --info-bg: #ebf5fb; --gray: #95a5a6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: #333; margin: 0; padding: 15px; line-height: 1.5; }
        
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        h1 { font-size: 1.6rem; text-align: center; color: #2c3e50; margin-bottom: 10px; }
        h2 { font-size: 1.3rem; color: #34495e; margin-top: 0; text-align: center; margin-bottom: 15px; }
        h3 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 30px; }
        
        .instruction { background-color: var(--info-bg); border-left: 5px solid var(--primary); padding: 15px; border-radius: 4px; margin-bottom: 25px; font-size: 0.95rem; color: #2c3e50; line-height: 1.6; }
        
        /* –ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å */
        .anon-switch { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: flex-start; gap: 10px; }
        .anon-switch input { width: 20px; height: 20px; margin-top: 3px; }
        .anon-warning { font-size: 0.85em; color: #856404; margin-top: 5px; display: none; }
        
        .step { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .step.active { display: block; opacity: 1; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #555; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; appearance: none; }
        input:disabled, select:disabled { background-color: #f9f9f9; color: #aaa; }
        
        .btn-container { display: flex; gap: 15px; margin-top: 25px; }
        .btn { flex: 1; padding: 16px; border: none; border-radius: 10px; font-size: 17px; font-weight: 600; cursor: pointer; transition: transform 0.1s; color: white; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-next { background-color: var(--primary); }
        .btn-back { background-color: var(--gray); }
        .btn-success { background-color: var(--success); }
        
        /* –¢–∞–±–ª–∏—Ü—ã –∏ –ö–∞—Ä—Ç–æ—á–∫–∏ (—Å—Ç–∏–ª–∏ –∏–∑ v8) */
        .option-card { border: 2px solid #eee; padding: 12px; margin-bottom: 8px; border-radius: 10px; display: flex; align-items: center; cursor: pointer; transition: all 0.2s; background: #fff; }
        .option-card input { width: 22px; height: 22px; margin-right: 15px; flex-shrink: 0; }
        .option-card.checked { border-color: var(--primary); background-color: #f0f9ff; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #f8f9fa; font-size: 0.85rem; color: #333; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        td:first-child { text-align: left; font-weight: 500; font-size: 0.95rem; width: 45%; }
        
        @media (max-width: 600px) {
            .container { padding: 15px; }
            th { font-size: 0.7rem; padding: 5px; }
            td { padding: 10px 2px; }
            td:first-child { font-size: 0.9rem; width: 100%; display: block; border-bottom: none; padding-bottom: 5px; color: var(--primary); font-weight: 600; }
            tr { display: block; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; }
            td:not(:first-child) { display: inline-block; width: 22%; border: none; }
            thead { display: none; } 
            td:not(:first-child)::before { content: attr(data-label); display: block; font-size: 0.7em; color: #888; margin-bottom: 5px; }
            input[type="radio"] { width: 24px; height: 24px; margin: 0; }
        }

        .progress-bar { height: 6px; background: #e9ecef; border-radius: 3px; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .error-msg { color: #fff; background: var(--error); padding: 12px; border-radius: 8px; margin-top: 20px; text-align: center; display: none; font-weight: bold; }
        .highlight-error { border: 2px solid var(--error) !important; background-color: #fff5f5 !important; }
        
        /* –°—Ç–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
        .res-block { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .score-badge { display: inline-block; padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 0.9em; }
        .bg-green { background: #d4edda; color: #155724; }
        .bg-red { background: #f8d7da; color: #721c24; }
        .bg-blue { background: #d1ecf1; color: #0c5460; }
        canvas { max-height: 300px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>

    <!-- –ê–ù–ö–ï–¢–ê -->
    <div class="step active" id="step-form">
        <h1>–ê–Ω–∫–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞</h1>
        
        <div class="anon-switch">
            <input type="checkbox" id="anon_mode" onchange="toggleAnon()">
            <div>
                <label for="anon_mode" style="margin:0; cursor:pointer;"><b>–ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å –∞–Ω–æ–Ω–∏–º–Ω–æ</b></label>
                <div class="anon-warning" id="anon_warning">
                    –°–≤–µ–¥–µ–Ω–∏—è –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–µ –ø–æ–º–æ–≥–∞—é—Ç –ø–æ–Ω—è—Ç—å, –¥–ª—è –∫–∞–∫–∏—Ö –≥—Ä—É–ø–ø –ª—é–¥–µ–π –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã –≤ –±–æ–ª—å—à–µ–π —Å—Ç–µ–ø–µ–Ω–∏. 
                    –û—Ç–∫–∞–∑ –æ—Ç –∏—Ö —É–∫–∞–∑–∞–Ω–∏—è –º–æ–∂–µ—Ç —É–º–µ–Ω—å—à–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –∏ –æ–±–æ–±—â–∞–µ–º–æ—Å—Ç—å –≤—ã–≤–æ–¥–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.
                </div>
            </div>
        </div>

        <div class="form-group"><label>–í–∞—à–µ –∏–º—è (–∏–ª–∏ –ø—Å–µ–≤–¥–æ–Ω–∏–º): <span class="req">*</span></label><input type="text" id="fio" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω"></div>
        
        <div style="display: flex; gap: 10px;">
            <div class="form-group" style="flex: 1;"><label>–ü–æ–ª: <span class="req">*</span></label><select id="gender"><option value="">–í—ã–±—Ä–∞—Ç—å...</option><option value="–ú—É–∂—Å–∫–æ–π">–ú—É–∂—Å–∫–æ–π</option><option value="–ñ–µ–Ω—Å–∫–∏–π">–ñ–µ–Ω—Å–∫–∏–π</option></select></div>
            <div class="form-group" style="flex: 1;"><label>–í–æ–∑—Ä–∞—Å—Ç: <span class="req">*</span></label><input type="number" id="age" placeholder="18"></div>
        </div>
        <div class="form-group"><label>–°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: <span class="req">*</span></label><select id="family_status"><option value="">–í—ã–±—Ä–∞—Ç—å...</option><option value="–•–æ–ª–æ—Å—Ç/–ù–µ –∑–∞–º—É–∂–µ–º">–•–æ–ª–æ—Å—Ç / –ù–µ –∑–∞–º—É–∂–µ–º</option><option value="–ñ–µ–Ω–∞—Ç/–ó–∞–º—É–∂–µ–º">–ñ–µ–Ω–∞—Ç / –ó–∞–º—É–∂–µ–º</option><option value="–í —Ä–∞–∑–≤–æ–¥–µ">–í —Ä–∞–∑–≤–æ–¥–µ</option></select></div>
        <div class="form-group"><label>–ï—Å—Ç—å –ª–∏ –¥–µ—Ç–∏? <span class="req">*</span></label><select id="children"><option value="–ù–µ—Ç">–ù–µ—Ç</option><option value="–î–∞">–î–∞</option></select></div>
        <div class="form-group"><label>–†–∞–±–æ—Ç–∞–µ—Ç–µ –ª–∏ –í—ã? <span class="req">*</span></label><select id="is_working" onchange="toggleWorkPlace()"><option value="–ù–µ—Ç">–ù–µ—Ç</option><option value="–î–∞">–î–∞</option></select></div>
        <div class="form-group" id="work_place_block" style="display: none;"><label>–ì–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç–µ? (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input type="text" id="work_place"></div>
        <div class="form-group"><label>–°—Ä–µ–¥–Ω–µ–µ —Å–ø–µ—Ü. –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ? <span class="req">*</span></label><select id="has_secondary_edu"><option value="–ù–µ—Ç">–ù–µ—Ç</option><option value="–î–∞">–î–∞</option></select></div>
        
        <div class="form-group"><label>–í–∞—à —Å—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è: <span class="req">*</span></label><select id="edu_status" onchange="toggleEduBlock()"><option value="">–í—ã–±—Ä–∞—Ç—å...</option><option value="–£—á—É—Å—å">–°—Ç—É–¥–µ–Ω—Ç (—É—á—É—Å—å —Å–µ–π—á–∞—Å)</option><option value="–ó–∞–∫–æ–Ω—á–∏–ª">–í—ã–ø—É—Å–∫–Ω–∏–∫ (—É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª)</option><option value="–ù–µ—Ç">–ù–µ —É—á–∏–ª—Å—è –≤ –í–£–ó–µ</option></select></div>
        <div id="edu_block" style="display: none; border-left: 3px solid #3498db; padding-left: 15px;">
            <div class="form-group"><label>–í–£–ó: <span class="req">*</span></label><input type="text" id="university"></div>
            <div class="form-group"><label>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å: <span class="req">*</span></label><input type="text" id="speciality"></div>
            <div class="form-group"><label>–ö—É—Ä—Å (–µ—Å–ª–∏ —É—á–∏—Ç–µ—Å—å):</label><select id="course"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
        </div>

        <div class="error-msg" id="form-error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ –ê–Ω–æ–Ω–∏–º–Ω—ã–π —Ä–µ–∂–∏–º!</div>
        <button class="btn btn-next" onclick="validateForm()">–ù–∞—á–∞—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</button>
    </div>

    <!-- –ú–ï–¢–û–î–ò–ö–ò (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ HTML, —Ç–æ–ª—å–∫–æ —Å–∫—Ä–∏–ø—Ç) -->
    <div class="step" id="step-bratus">
        <h2>1/3. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–µ —Å–º—ã—Å–ª—ã</h2>
        <div class="instruction">
            <p>–ü–µ—Ä–µ–¥ –≤–∞–º–∏ —Å–ø–∏—Å–æ–∫ –∏–∑ 24 —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π. –≠—Ç–æ –ø–µ—Ä–µ—á–µ–Ω—å –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Å–º—ã—Å–ª–æ–≤.</p>
            <p>–í–∞–º –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç —Å–¥–µ–ª–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥–æ–≤—É—é –æ—Ü–µ–Ω–∫—É. –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ <b>—Ç—Ä–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</b>, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–Ω–∏–º–∞—é—Ç <b>1-–µ –º–µ—Å—Ç–æ</b> –≤ —Å–∏—Å—Ç–µ–º–µ –í–∞—à–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π, –∑–∞—Ç–µ–º —Ç—Ä–∏ –¥–ª—è 2-–≥–æ –º–µ—Å—Ç–∞ –∏ —Ç.–¥.</p>
        </div>
        <p style="text-align:center; font-weight:bold; color:#2980b9; margin-bottom:10px;" id="bratus-sub">–í—ã–±–µ—Ä–∏—Ç–µ 3 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö</p>
        <div id="bratus-options"></div>
        <div class="error-msg" id="bratus-error">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–≤–Ω–æ 3 –ø—É–Ω–∫—Ç–∞!</div>
        <div class="btn-container"><button class="btn btn-back" onclick="prevBratusRank()">–ù–∞–∑–∞–¥</button><button class="btn btn-next" onclick="nextBratusRank()">–î–∞–ª–µ–µ</button></div>
    </div>

    <div class="step" id="step-milman">
        <h2>2/3. –ú–æ—Ç–∏–≤–∞—Ü–∏—è</h2>
        <div class="instruction">
            <p>–û—Ü–µ–Ω–∏—Ç–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –∫–∞—Å–∞—é—â–∏–µ—Å—è –≤–∞—à–∏—Ö –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–π:</p>
            <ul><li><b>++</b> (–¥–∞, —Å–æ–≥–ª–∞—Å–µ–Ω)</li><li><b>+</b> (–ø–æ–∂–∞–ª—É–π)</li><li><b>=</b> (–∫–æ–≥–¥–∞ –∫–∞–∫)</li><li><b>- / ?</b> (–Ω–µ—Ç / –Ω–µ –∑–Ω–∞—é)</li></ul>
        </div>
        <div id="milman-container"></div>
        <div class="error-msg" id="milman-error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–ø—É—Å–∫–∏!</div>
        <div class="btn-container"><button class="btn btn-back" onclick="prevMilman()">–ù–∞–∑–∞–¥</button><button class="btn btn-next" onclick="finishMilman()">–î–∞–ª–µ–µ</button></div>
    </div>

    <div class="step" id="step-ipl">
        <h2>3/3. –ò–Ω–Ω–æ–≤–∞—Ü–∏–∏</h2>
        <div class="instruction">
            <p>–û—Ü–µ–Ω–∏—Ç–µ, –≤ –∫–∞–∫–æ–π –º–µ—Ä–µ –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏—è –æ–ø–∏—Å—ã–≤–∞—é—Ç –í–∞—Å (–æ—Ç 1 –¥–æ 5):</p>
            <p>1 - –ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω ... 5 - –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≥–ª–∞—Å–µ–Ω</p>
        </div>
        <div id="ipl-container"></div>
        <div class="error-msg" id="ipl-error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–ø—É—Å–∫–∏!</div>
        <div class="btn-container"><button class="btn btn-back" onclick="prevIPL()">–ù–∞–∑–∞–¥</button><button class="btn btn-success" onclick="finishSurvey()">–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button></div>
    </div>

    <div class="step" id="step-loading" style="text-align:center; padding: 40px 0;">
        <h2 style="color:var(--primary)">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</h2>
        <div class="spinner"></div>
    </div>

    <!-- –†–ï–ó–£–õ–¨–¢–ê–¢–´ -->
    <div class="step" id="step-results">
        <h1 style="color:var(--success)">–í–∞—à –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ü–æ—Ä—Ç—Ä–µ—Ç</h1>
        <p style="text-align:center">–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ! –í–æ—Ç —á—Ç–æ —É –Ω–∞—Å –ø–æ–ª—É—á–∏–ª–æ—Å—å:</p>
        
        <div class="res-block">
            <h3>üéØ 1. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–µ —Å–º—ã—Å–ª—ã (–ë—Ä–∞—Ç—É—Å—å)</h3>
            <p>–ß–µ–º –Ω–∏–∂–µ —Å—Ç–æ–ª–±–µ—Ü, —Ç–µ–º <b>–≤–∞–∂–Ω–µ–µ</b> –¥–ª—è –≤–∞—Å —ç—Ç–∞ —Å—Ñ–µ—Ä–∞ (–º–µ–Ω—å—à–µ —Å—É–º–º–∞ —Ä–∞–Ω–≥–æ–≤).</p>
            <canvas id="chartBratus"></canvas>
            <div id="textBratus" style="margin-top:15px; font-size:0.9em;"></div>
        </div>

        <div class="res-block">
            <h3>üî• 2. –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (–ú–∏–ª—å–º–∞–Ω)</h3>
            <p>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–≥–æ, —á–µ–≥–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ (–ò–¥–µ–∞–ª—å–Ω–æ–µ), –∏ —Ç–æ–≥–æ, —á—Ç–æ –µ—Å—Ç—å (–†–µ–∞–ª—å–Ω–æ–µ).</p>
            <canvas id="chartMilman"></canvas>
            <div id="textMilman" style="margin-top:15px;"></div>
        </div>

        <div class="res-block">
            <h3>üöÄ 3. –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–ò–ü–õ)</h3>
            <div id="textIPL"></div>
        </div>

        <div style="text-align:center; margin-top:30px;">
            <p style="color:#666; font-size:0.8em">–î–∞–Ω–Ω—ã–µ —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—é.</p>
            <button class="btn btn-secondary" onclick="window.location.reload()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        </div>
    </div>
</div>

<script>
// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbyBH_ksIaHmQxklthf1SgxzmhxAPkqABdkTFTin1TObQJZ98DudLE_20IbqEHR-SKaqCg/exec";

// --- –î–ê–ù–ù–´–ï –í–û–ü–†–û–°–û–í (–ö–æ–º–ø–∞–∫—Ç–Ω–æ) ---
const bratus_stmts=[{id:1,t:"...—á—Ç–æ–±—ã –ø–æ–º–æ–≥–∞—Ç—å –¥—Ä—É–≥–∏–º –ª—é–¥—è–º"},{id:2,t:"...—á—Ç–æ–±—ã –±—ã—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–º"},{id:3,t:"...—á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ"},{id:4,t:"...—á—Ç–æ–±—ã —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞—Ç—å—Å—è"},{id:5,t:"...—á—Ç–æ–±—ã –¥–æ–±–∏–≤–∞—Ç—å—Å—è —É—Å–ø–µ—Ö–∞"},{id:6,t:"...—á—Ç–æ–±—ã –±—ã—Ç—å —Å –±–ª–∏–∑–∫–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º"},{id:7,t:"...—á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –≤—Å–µ –ª—É—á—à–µ–µ —Å–≤–æ–∏–º –¥–µ—Ç—è–º"},{id:8,t:"...—á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å —Å–µ–±—è —Å–∞–º–æ–≥–æ"},{id:9,t:"...—á—Ç–æ–±—ã –¥–µ–ª–∞—Ç—å –¥–æ–±—Ä–æ"},{id:10,t:"...—á—Ç–æ–±—ã –∂–∏—Ç—å"},{id:11,t:"...—á—Ç–æ–±—ã –∏—Å–ø—ã—Ç—ã–≤–∞—Ç—å —Å—á–∞—Å—Ç—å–µ"},{id:12,t:"...—á—Ç–æ–±—ã –æ—Å—É—â–µ—Å—Ç–≤–∏—Ç—å —Å–µ–±—è"},{id:13,t:"...—á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ö–æ—Ä–æ—à—É—é –∫–∞—Ä—å–µ—Ä—É"},{id:14,t:"...—á—Ç–æ–±—ã —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å, —á—Ç–æ –∫–æ–º—É-—Ç–æ –Ω—É–∂–µ–Ω"},{id:15,t:"...—á—Ç–æ–±—ã –∂–∏—Ç—å —Ä–∞–¥–∏ —Å–≤–æ–µ–π —Å–µ–º—å–∏"},{id:16,t:"...—á—Ç–æ–±—ã –ø–æ–∑–Ω–∞–≤–∞—Ç—å –ë–æ–≥–∞"},{id:17,t:"...—á—Ç–æ–±—ã —É–ª—É—á—à–∞—Ç—å –º–∏—Ä"},{id:18,t:"...—á—Ç–æ–±—ã –ª—é–±–∏—Ç—å"},{id:19,t:"...—á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –±–æ–ª—å—à–µ –æ—â—É—â–µ–Ω–∏–π"},{id:20,t:"...—á—Ç–æ–±—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏"},{id:21,t:"...—á—Ç–æ–±—ã –∑–∞–Ω–∏–º–∞—Ç—å –¥–æ—Å—Ç–æ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ"},{id:22,t:"...—á—Ç–æ–±—ã —Ä–∞–¥–æ–≤–∞—Ç—å—Å—è –æ–±—â–µ–Ω–∏—é"},{id:23,t:"...—á—Ç–æ–±—ã –ø–æ–º–æ–≥–∞—Ç—å —Ä–æ–¥–Ω—ã–º"},{id:24,t:"...—á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –∂–∏–∑–Ω—å"}];
const milman_qs=[{q:"–í –∂–∏–∑–Ω–∏ –Ω—É–∂–Ω–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è:",i:["–í—Ä–µ–º—è-–¥–µ–Ω—å–≥–∏","–ó–¥–æ—Ä–æ–≤—å–µ","–î—Ä—É–∑—å—è","–°–µ–º—å—è","–î–æ–±—Ä–æ","–°—Ç–∞—Ç—É—Å","–ó–Ω–∞–Ω–∏—è","–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ"]},{q:"–ù–∞ —Ä–∞–±–æ—Ç–µ –Ω—É–∂–Ω–æ:",i:["–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å","–ë–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤","–ö–æ–º—Ñ–æ—Ä—Ç","–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ","–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç","–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ","–ò–Ω—Ç–µ—Ä–µ—Å","–õ–∏–¥–µ—Ä—Å—Ç–≤–æ"]},{q:"–í —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è:",i:["–î–æ–º","–û—Ç–¥—ã—Ö","–î—Ä—É–∑—å—è","–û–±—â–µ—Å—Ç–≤–æ","–î–µ—Ç–∏","–£—á–µ–±–∞","–•–æ–±–±–∏","–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞"]},{q:"–í —Ä–∞–±–æ—Ç–µ –∑–∞–Ω–∏–º–∞–µ—Ç –º–µ—Å—Ç–æ:",i:["–î–µ–ª–æ–≤–æ–µ –æ–±—â–µ–Ω–∏–µ","–õ–∏—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ","–û–±—â–µ—Å—Ç–≤–µ–Ω–Ω–∞—è","–£—á–µ–±–∞","–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ","–ó–∞—Ä–∞–±–æ—Ç–æ–∫","–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å","–û—Ç–¥—ã—Ö"]},{q:"–õ–∏—à–Ω–∏–π –≤—ã—Ö–æ–¥–Ω–æ–π –ø–æ—Ç—Ä–∞—á—É:",i:["–î–æ–º","–û—Ç–¥—ã—Ö","–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è","–û–±—â–µ—Å—Ç–≤–æ","–£—á–µ–±–∞","–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ","–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å","–ó–∞—Ä–∞–±–æ—Ç–æ–∫"]},{q:"–°–≤–æ–±–æ–¥–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫:",i:["–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏","–î–µ–ª–æ–≤–æ–µ –æ–±—â–µ–Ω–∏–µ","–õ–∏—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ","–û–±—â–µ—Å—Ç–≤–æ","–£—á–µ–±–∞","–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ","–ü–æ–ª—å–∑–∞","–ó–∞—Ä–∞–±–æ—Ç–æ–∫"]},{q:"–¢–µ–º—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤:",i:["–ü–æ–∫—É–ø–∫–∏","–ó–Ω–∞–∫–æ–º—ã–µ","–í–æ–∫—Ä—É–≥","–£—Å–ø–µ—Ö","–†–∞–±–æ—Ç–∞","–£–≤–ª–µ—á–µ–Ω–∏—è","–ü–ª–∞–Ω—ã","–ü–æ–ª–∏—Ç–∏–∫–∞"]},{q:"–†–∞–±–æ—Ç–∞ –¥–∞–µ—Ç:",i:["–î–µ–Ω—å–≥–∏","–û–±—â–µ–Ω–∏–µ","–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç","–í—Å—Ç—Ä–µ—á–∏","–£–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ","–ü–æ–ª—å–∑—É","–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ","–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ"]},{q:"–•–æ—á—É –æ–±—â–µ—Å—Ç–≤–æ –≥–¥–µ:",i:["–£—é—Ç","–†–∞–±–æ—Ç–∞","–£–≤–∞–∂–µ–Ω–∏–µ","–°–≤—è–∑–∏","–î—Ä—É–∑—å—è","–ò–∑–≤–µ—Å—Ç–Ω–æ—Å—Ç—å","–î–µ–ª–æ","–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏"]},{q:"–ö–æ–ª–ª–µ–≥–∏:",i:["–†–∞–∑–≥–æ–≤–æ—Ä—ã","–û–ø—ã—Ç","–î–µ–Ω—å–≥–∏","–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç","–£—á–µ–±–∞","–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å","–ó–Ω–∞–Ω–∏—è","–ü–æ–¥–¥–µ—Ä–∂–∫–∞"]},{q:"–ò–º–µ—é –≤ –¥–æ—Å—Ç–∞—Ç–∫–µ:",i:["–î–µ–Ω—å–≥–∏","–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è","–£—Å–ª–æ–≤–∏—è","–°–µ–º—å—é","–û–±—â–µ–Ω–∏–µ","–£–≤–∞–∂–µ–Ω–∏–µ","–ü–æ–ª—å–∑—É","–¶–µ–Ω–Ω–æ–µ"]},{q:"–ò–º–µ—é –≤ —Ä–∞–±–æ—Ç–µ:",i:["–ó–∞—Ä–ø–ª–∞—Ç—É","–£—Å–ª–æ–≤–∏—è","–ö–æ–ª–ª–µ–∫—Ç–∏–≤","–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è","–î–æ–ª–∂–Ω–æ—Å—Ç—å","–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å","–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç","–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ"]},{q:"–ù—Ä–∞–≤–∏—Ç—Å—è –∫–æ–≥–¥–∞:",i:["–ù–µ—Ç –∑–∞–±–æ—Ç","–ö–æ–º—Ñ–æ—Ä—Ç","–°—É–µ—Ç–∞","–í–µ—Å–µ–ª—å–µ","–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ","–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ","–ü–æ–≥—Ä—É–∂–µ–Ω–∏–µ","–°–æ–≤–º–µ—Å—Ç–Ω–æ—Å—Ç—å"]},{q:"–ü—Ä–∏ –Ω–µ—É–¥–∞—á–µ:",i:["–†–∞—Å—Å—Ç—Ä–∞–∏–≤–∞—é—Å—å","–ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å","–¢–µ—Ä—è—é—Å—å","–ó–ª—é—Å—å","–°–ø–æ–∫–æ–µ–Ω","–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é","–í–∏–Ω–æ–≤–∞—Ç —Å–∞–º","–ò—â—É –ø—Ä–∏—á–∏–Ω—ã"]}];
const ipl_qs=["–ó–Ω–∞–Ω–∏—è –∏–∑ –∫–Ω–∏–≥","–ë—É–¥—É—â–µ–µ –Ω–µ –ø—É–≥–∞–µ—Ç","–≠–∫—Å—Ç—Ä–∏–º","–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ","–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ","–ü–µ—Ä–µ–º–µ–Ω—ã –Ω–µ —Ç—Ä–µ–≤–æ–∂–∞—Ç","–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —ç–∫–æ–ª–æ–≥–∏—é","–ü–µ—Ä–µ–º–µ–Ω—ã –Ω–∞ –¥–æ—Ä–æ–≥–µ","–ö—Ä–∏–∑–∏—Å","–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä–µ–¥—è—Ç","–ù–æ–≤—ã–π —á–µ–ª–æ–≤–µ–∫","–ú–µ—Å—Ç–æ –æ—Ç–¥—ã—Ö–∞","–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞","–ú–Ω–æ–≥–æ –Ω–æ–≤–æ–≥–æ","–ù–æ–≤–æ–µ –¥–µ–ª–æ","–ö—É–ª—å—Ç—É—Ä–∞","–°–º–µ–Ω–∞ —Ä–∞–±–æ—Ç—ã","–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∂–∏–∑–Ω—å","–†–∏—Ç–º –º–∏—Ä–∞","–ü—Ä–∞–≤–∏–ª–∞","–°–ø—Ä–æ—Å–∏—Ç—å —Å–ø–µ—Ü–æ–≤","–î—Ä—É–≥","–¢—Ä–∞–¥–∏—Ü–∏–∏","–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞","–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å","–ö–æ–ª–ª–µ–∫—Ç–∏–≤","–°–∫–µ–ø—Ç–∏–∫","–í—Ä–µ–º—è","–†–∞–¥—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è","–ù–æ–≤–∞—è —Å—Ñ–µ—Ä–∞","–ù—É–∂–¥–∞","–ü–æ–ª–∏—Ç–∏–∫–∞","–†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ","–†–µ—à–µ–Ω–∏–µ","–ú–µ—Å—Ç–Ω–æ—Å—Ç—å","–û–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞"];

// –°–æ—Å—Ç–æ—è–Ω–∏–µ
let state = { meta: {}, bratus: {}, rank: 1, milman: {}, ipl: {} };
let anonMode = false;

// --- –õ–û–ì–ò–ö–ê –ê–ù–ö–ï–¢–´ ---
function toggleAnon() {
    anonMode = document.getElementById('anon_mode').checked;
    document.getElementById('anon_warning').style.display = anonMode ? 'block' : 'none';
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–µ–π
    const reqs = document.querySelectorAll('.req');
    reqs.forEach(el => el.style.display = anonMode ? 'none' : 'inline');
    
    // –°–µ—Ä—ã–º —Ü–≤–µ—Ç–æ–º –ø–æ–ª—è
    const inputs = document.querySelectorAll('#step-form input:not(#anon_mode), #step-form select');
    inputs.forEach(el => el.style.backgroundColor = anonMode ? '#f9f9f9' : '#fff');
}

function toggleWorkPlace() { document.getElementById('work_place_block').style.display = (document.getElementById('is_working').value === "–î–∞") ? 'block' : 'none'; }
function toggleEduBlock() {
    const status = document.getElementById('edu_status').value;
    document.getElementById('edu_block').style.display = (status === "–£—á—É—Å—å" || status === "–ó–∞–∫–æ–Ω—á–∏–ª") ? 'block' : 'none';
}

function validateForm() {
    let ids = ['fio','gender','age','family_status','children','is_working','has_secondary_edu','edu_status'];
    const status = document.getElementById('edu_status').value;
    if(status === '–£—á—É—Å—å') ids = ids.concat(['university','speciality']); // –£–ø—Ä–æ—Å—Ç–∏–ª –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
    
    let valid = true;
    if (!anonMode) {
        ids.forEach(id => {
            let el = document.getElementById(id);
            if(!el || !el.value) { 
                if(el) el.style.borderColor = "var(--error)"; 
                valid = false; 
            } else { 
                if(el) el.style.borderColor = "#ddd"; 
                state.meta[id] = el.value; 
            }
        });
    } else {
        // –í –∞–Ω–æ–Ω–∏–º–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á—Ç–æ –µ—Å—Ç—å
        ids.forEach(id => { let el = document.getElementById(id); if(el) state.meta[id] = el.value || "–ê–Ω–æ–Ω–∏–º"; });
    }

    if(!valid) { document.getElementById('form-error').style.display = 'block'; return; }
    
    switchStep('step-form', 'step-bratus');
    renderBratus();
}

// --- –ë–†–ê–¢–£–°–¨ (–†–µ–Ω–¥–µ—Ä) ---
function renderBratus() {
    const c = document.getElementById('bratus-options'); c.innerHTML = "";
    document.getElementById('bratus-sub').innerHTML = `–í—ã–±–µ—Ä–∏—Ç–µ <b>3</b> —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è <b>${state.rank}-–≥–æ –º–µ—Å—Ç–∞</b>`;
    document.getElementById('progress').style.width = (state.rank/8*30)+"%";
    
    let used = []; 
    for(let k in state.bratus) if(parseInt(k) !== state.rank) used = used.concat(state.bratus[k]);
    
    bratus_stmts.forEach(s => {
        if(!used.includes(s.id)) {
            let div = document.createElement('div'); div.className = 'option-card'; div.innerHTML = `<input type="checkbox" value="${s.id}"> ${s.t}`;
            if(state.bratus[state.rank] && state.bratus[state.rank].includes(s.id)) { div.classList.add('checked'); div.querySelector('input').checked = true; }
            div.onclick = (e) => { if(e.target.tagName!=='INPUT') div.querySelector('input').click(); div.classList.toggle('checked', div.querySelector('input').checked); };
            c.appendChild(div);
        }
    });
}
function nextBratusRank() {
    const ch = document.querySelectorAll('#bratus-options input:checked');
    if(ch.length !== 3) { document.getElementById('bratus-error').style.display = 'block'; return; }
    document.getElementById('bratus-error').style.display = 'none';
    state.bratus[state.rank] = Array.from(ch).map(i => parseInt(i.value));
    if(state.rank < 8) { state.rank++; renderBratus(); window.scrollTo(0,0); }
    else { switchStep('step-bratus', 'step-milman'); renderMilman(); }
}
function prevBratusRank() { if(state.rank > 1) { state.rank--; renderBratus(); } else switchStep('step-bratus', 'step-form'); }

// --- –ú–ò–õ–¨–ú–ê–ù (–†–µ–Ω–¥–µ—Ä) ---
function renderMilman() {
    const c = document.getElementById('milman-container');
    document.getElementById('progress').style.width = "60%";
    if(c.innerHTML) return; 
    milman_qs.forEach((q, qi) => {
        let h = `<div class="q-block"><h3>${qi+1}. ${q.q}</h3><table><thead><tr><th>–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</th><th>++ (–î–∞)</th><th>+ (–ü–æ–∂.)</th><th>= (–¢–∞–∫ —Å–µ–±–µ)</th><th>-/? (–ù–µ—Ç)</th></tr></thead><tbody>`;
        q.i.forEach((txt, ii) => {
            let nm = `m_${qi}_${ii}`;
            h += `<tr id="row_${nm}"><td>${txt}</td>
            <td data-label="++"><input type="radio" name="${nm}" value="3" onclick="saveM('${nm}',3)"></td>
            <td data-label="+"><input type="radio" name="${nm}" value="2" onclick="saveM('${nm}',2)"></td>
            <td data-label="="><input type="radio" name="${nm}" value="1" onclick="saveM('${nm}',1)"></td>
            <td data-label="-"><input type="radio" name="${nm}" value="0" onclick="saveM('${nm}',0)"></td></tr>`;
        });
        c.innerHTML += h + "</tbody></table></div>";
    });
}
function saveM(k, v) { state.milman[k.replace('m_','')] = v; document.getElementById('row_'+k).classList.remove('highlight-error'); }
function finishMilman() {
    if(!validateGroup('m', 14, 8)) return;
    switchStep('step-milman', 'step-ipl');
    renderIPL();
}
function prevMilman() { switchStep('step-milman', 'step-bratus'); }

// --- –ò–ü–õ (–†–µ–Ω–¥–µ—Ä) ---
function renderIPL() {
    const c = document.getElementById('ipl-container');
    document.getElementById('progress').style.width = "90%";
    if(c.innerHTML) return;
    let h = `<table><thead><tr><th>–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</th><th>1 (–ù–µ—Ç)</th><th>2</th><th>3</th><th>4</th><th>5 (–î–∞)</th></tr></thead><tbody>`;
    ipl_qs.forEach((txt, i) => {
        let nm = `ipl_${i}`;
        h += `<tr id="row_${nm}"><td>${i+1}. ${txt}</td>${[1,2,3,4,5].map(v => `<td data-label="${v}"><input type="radio" name="${nm}" value="${v}" onclick="saveI(${i},${v})"></td>`).join('')}</tr>`;
    });
    c.innerHTML = h + "</tbody></table>";
}
function saveI(i, v) { state.ipl[i] = v; document.getElementById('row_ipl_'+i).classList.remove('highlight-error'); }
function prevIPL() { switchStep('step-ipl', 'step-milman'); }

// --- –û–ë–†–ê–ë–û–¢–ö–ê –ò –í–´–í–û–î –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ---
function finishSurvey() {
    if(!validateGroup('ipl', 36, 1)) return;
    switchStep('step-ipl', 'step-loading');
    
    // 1. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google (—Ñ–æ–Ω–æ–º)
    fetch(GOOGLE_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(state) })
    .catch(console.error);

    // 2. –†–∞—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    calculateAndShowResults();
}

function calculateAndShowResults() {
    // --- 1. –ë–†–ê–¢–£–°–¨ (–¢–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç) ---
    // ID –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const cats_map = { 
        '–ê–ª—å—Ç—Ä—É–∏–∑–º': [1,9,17], '–≠–∫–∑–∏—Å—Ç–µ–Ω—Ü.': [2,10,18], '–ì–µ–¥–æ–Ω–∏–∑–º': [3,11,19], 
        '–°–∞–º–æ—Ä–µ–∞–ª–∏–∑.': [4,12,20], '–°—Ç–∞—Ç—É—Å': [5,13,21], '–ö–æ–º–º—É–Ω–∏–∫.': [6,14,22], 
        '–°–µ–º—å—è': [7,15,23], '–ö–æ–≥–Ω–∏—Ç–∏–≤.': [8,16,24] 
    };
    let b_labels=[], b_data=[];
    
    // –ò–Ω–≤–µ—Ä—Å–∏—è: {rank: [ids]} -> {id: rank}
    let id_to_rank = {};
    for(let r in state.bratus) state.bratus[r].forEach(id => id_to_rank[id] = parseInt(r));
    
    for(let c in cats_map) {
        let sum = 0;
        cats_map[c].forEach(id => sum += (id_to_rank[id] || 0)); 
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–¥—Ä—É–≥ –ø—Ä–æ–ø—É—Å—Ç–∏–ª (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ), —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ 0, –Ω–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –¥–∞—Å—Ç
        b_labels.push(c);
        b_data.push(sum);
    }

    // --- 2. –ú–ò–õ–¨–ú–ê–ù (–ü–û–õ–ù–ê–Ø –ú–ê–¢–†–ò–¶–ê –ö–õ–Æ–ß–ï–ô) ---
    // –ú–∞—Ç—Ä–∏—Ü–∞ –∫–ª—é—á–µ–π (14 –≤–æ–ø—Ä–æ—Å–æ–≤ x 8 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤). P=–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ, K=–ö–æ–º—Ñ–æ—Ä—Ç –∏ —Ç.–¥.
    const m_keys = [
        ['P','P','O','D','OD','S','DR','DR'], // 1
        ['P','K','K','S','S','DR','DR','OD'], // 2
        ['P','K','O','OD','OD','-','D','P'],  // 3
        ['D','O','OD','D','DR','P','OD','K'], // 4
        ['P','K','K','OD','DR','DR','OD','P'], // 5
        ['D','D','O','S','-','DR','OD','P'],   // 6
        ['K','O','S','S','P','DR','DR','O'],   // 7
        ['P','O','S','O','DR','OD','DR','S'],  // 8
        ['K','D','S','S','O','S','D','K'],     // 9
        ['O','OD','P','S','P','OD','DR','-'],  // 10
        ['P','K','K','O','S','S','OD','DR'],   // 11
        ['P','K','K','DR','S','S','OD','P'],   // 12
        ['-','-','-','-','-','-','-','-'],     // 13 (–≠–º–æ—Ü–∏–∏ –Ω–µ —Ä–∏—Å—É–µ–º –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –ø—Ä–æ—Ñ–∏–ª—è)
        ['-','-','-','-','-','-','-','-']      // 14
    ];
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–¥—à–∫–∞–ª (–ò–¥–µ–∞–ª—å–Ω–æ–µ/–†–µ–∞–ª—å–Ω–æ–µ)
    // –í–æ–ø—Ä–æ—Å—ã 0,4,8 -> –ñ–∏—Ç–µ–π—Å–∫–∞—è –ò–¥–µ–∞–ª—å–Ω–∞—è (Zh-id) –∏ —Ç.–¥.
    const sub_map = {
        0:'id', 4:'id', 8:'id',  // –ñ–∏–∑–Ω—å –ò–¥–µ–∞–ª
        1:'id', 5:'id', 9:'id',  // –†–∞–±–æ—Ç–∞ –ò–¥–µ–∞–ª
        2:'re', 6:'re', 10:'re', // –ñ–∏–∑–Ω—å –†–µ–∞–ª
        3:'re', 7:'re', 11:'re'  // –†–∞–±–æ—Ç–∞ –†–µ–∞–ª
    };

    let m_scores = { 
        'id': {'P':0,'K':0,'S':0,'O':0,'D':0,'DR':0,'OD':0}, 
        're': {'P':0,'K':0,'S':0,'O':0,'D':0,'DR':0,'OD':0} 
    };

    for(let q=0; q<12; q++) { // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 12 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è
        let type = sub_map[q]; // 'id' –∏–ª–∏ 're'
        for(let i=0; i<8; i++) {
            let val = state.milman[`${q}_${i}`] || 0;
            let scale = m_keys[q][i];
            if(scale !== '-' && m_scores[type][scale] !== undefined) {
                m_scores[type][scale] += val;
            }
        }
    }
    
    // –ü–æ—Ä—è–¥–æ–∫ —à–∫–∞–ª –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
    const scales_order = ['P','K','S','O','D','DR','OD'];
    const scales_names = ['–ñ–∏–∑–Ω–µ–æ–±.','–ö–æ–º—Ñ–æ—Ä—Ç','–°—Ç–∞—Ç—É—Å','–û–±—â–µ–Ω–∏–µ','–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å','–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ','–ü–æ–ª—å–∑–∞'];
    let data_id = scales_order.map(s => m_scores['id'][s]);
    let data_re = scales_order.map(s => m_scores['re'][s]);

    // --- 3. –ò–ü–õ (–¢–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å —Ä–µ–≤–µ—Ä—Å–æ–º) ---
    let ipl_sum = 0;
    // –ò–Ω–¥–µ–∫—Å—ã –æ–±—Ä–∞—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 0)
    let rev_idx = [0, 4, 6, 8, 9, 13, 14, 15, 19, 21, 23, 24, 25, 26, 27, 30, 31, 32];
    
    for(let i=0; i<36; i++) {
        let val = state.ipl[i]; // 1..5
        if(rev_idx.includes(i)) val = 6 - val; // –†–µ–≤–µ—Ä—Å
        ipl_sum += val;
    }

    // --- –û–¢–†–ò–°–û–í–ö–ê ---
    setTimeout(() => {
        switchStep('step-loading', 'step-results');
        
        // 1. –ì—Ä–∞—Ñ–∏–∫ –ë—Ä–∞—Ç—É—Å—è
        if(window.chartB) window.chartB.destroy(); // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –µ—Å–ª–∏ –µ—Å—Ç—å
        let ctxB = document.getElementById('chartBratus').getContext('2d');
        window.chartB = new Chart(ctxB, {
            type: 'bar',
            data: {
                labels: b_labels,
                datasets: [{ label: '–†–∞–Ω–≥ (–ú–µ–Ω—å—à–µ = –í–∞–∂–Ω–µ–µ)', data: b_data, backgroundColor: '#3498db' }]
            },
            options: { scales: { y: { reverse: true, min: 0, max: 25 } } }
        });
        
        // 2. –ì—Ä–∞—Ñ–∏–∫ –ú–∏–ª—å–º–∞–Ω–∞ (–¢–µ–ø–µ—Ä—å —Ç–æ—á–Ω—ã–π!)
        if(window.chartM) window.chartM.destroy();
        let ctxM = document.getElementById('chartMilman').getContext('2d');
        window.chartM = new Chart(ctxM, {
            type: 'line',
            data: {
                labels: scales_names,
                datasets: [
                    { label: '–ñ–µ–ª–∞–µ–º–æ–µ (–ò–¥–µ–∞–ª)', data: data_id, borderColor: '#27ae60', backgroundColor: 'rgba(39,174,96,0.1)', fill: true, tension: 0.3 },
                    { label: '–¢–µ–∫—É—â–µ–µ (–†–µ–∞–ª)', data: data_re, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: true, tension: 0.3 }
                ]
            },
            options: { scales: { y: { min: 0 } } }
        });
        document.getElementById('textMilman').innerHTML = `<p>–ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑—Ä—ã–≤ –º–µ–∂–¥—É —Ç–µ–º, –∫ —á–µ–º—É –≤—ã —Å—Ç—Ä–µ–º–∏—Ç–µ—Å—å (–ó–µ–ª–µ–Ω–∞—è –ª–∏–Ω–∏—è), –∏ —Ç–µ–º, —á—Ç–æ –∏–º–µ–µ—Ç–µ —Å–µ–π—á–∞—Å (–ö—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è).</p>`;

        // 3. –†–µ–∑—É–ª—å—Ç–∞—Ç –ò–ü–õ
        let ipl_level = ipl_sum >= 118 ? "–í—ã—Å–æ–∫–∏–π" : (ipl_sum >= 95 ? "–°—Ä–µ–¥–Ω–∏–π" : "–ù–∏–∑–∫–∏–π");
        let ipl_cls = ipl_sum >= 118 ? "bg-green" : (ipl_sum >= 95 ? "bg-blue" : "bg-red");
        
        document.getElementById('textIPL').innerHTML = `
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <div style="font-size:2.5em; font-weight:bold; color:#2c3e50;">${ipl_sum}</div>
                <div>
                    <span class="score-badge ${ipl_cls}" style="font-size:1.1em;">–£—Ä–æ–≤–µ–Ω—å: ${ipl_level}</span>
                    <div style="font-size:0.8em; color:#777;">–ú–∞–∫—Å–∏–º—É–º: 180</div>
                </div>
            </div>
            <p>
                ${ipl_level === "–í—ã—Å–æ–∫–∏–π" ? "–£ –≤–∞—Å –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–∑–≤–∏—Ç–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º. –í—ã –Ω–µ –±–æ–∏—Ç–µ—Å—å –ø–µ—Ä–µ–º–µ–Ω, –ª–µ–≥–∫–æ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç–µ—Å—å –∫ –Ω–æ–≤—ã–º —É—Å–ª–æ–≤–∏—è–º –∏ –≥–æ—Ç–æ–≤—ã –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∏–¥–µ–∏." : 
                  ipl_level === "–°—Ä–µ–¥–Ω–∏–π" ? "–£ –≤–∞—Å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –Ω–æ–≤–æ–º—É. –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏, –µ—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –≤ –Ω–∏—Ö —Å–º—ã—Å–ª –∏ –ø–æ–ª—å–∑—É, –Ω–æ –∏–∑–±–µ–≥–∞–µ—Ç–µ –Ω–µ–æ–ø—Ä–∞–≤–¥–∞–Ω–Ω–æ–≥–æ —Ä–∏—Å–∫–∞." : 
                  "–í—ã —Ü–µ–Ω–∏—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å. –ü–µ—Ä–µ–º–µ–Ω—ã –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å —Å—Ç—Ä–µ—Å—Å, –≤—ã –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–µ–º –º–µ—Ç–æ–¥—ã."}
            </p>
        `;

    }, 1000);
}


// –£—Ç–∏–ª–∏—Ç—ã
function switchStep(f, t) { document.getElementById(f).classList.remove('active'); setTimeout(() => document.getElementById(t).classList.add('active'), 200); window.scrollTo(0,0); }
function validateGroup(prefix, c1, c2) {
    let err = null; let cont = prefix==='m'?state.milman:state.ipl;
    if(c2===1) { for(let i=0;i<c1;i++) if(!cont[i]) { err=document.getElementById('row_ipl_'+i); err.classList.add('highlight-error'); break; } }
    else { for(let q=0;q<c1;q++) for(let i=0;i<c2;i++) if(cont[`${q}_${i}`]===undefined) { err=document.getElementById(`row_m_${q}_${i}`); err.classList.add('highlight-error'); break; } }
    if(err) { err.scrollIntoView({behavior:"smooth", block:"center"}); document.getElementById(prefix==='m'?'milman-error':'ipl-error').style.display='block'; return false; }
    return true;
}
</script>
</body>
</html>
