<script>
// --- КОНФИГУРАЦИЯ ---
const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbyBH_ksIaHmQxklthf1SgxzmhxAPkqABdkTFTin1TObQJZ98DudLE_20IbqEHR-SKaqCg/exec";
const STORAGE_KEY = "survey_state_v10";

// ДАННЫЕ
const bratus_stmts=[{id:1,t:"...чтобы помогать другим людям"},{id:2,t:"...чтобы быть свободным"},{id:3,t:"...чтобы получать удовольствие"},{id:4,t:"...чтобы совершенствоваться"},{id:5,t:"...чтобы добиваться успеха"},{id:6,t:"...чтобы быть с близким человеком"},{id:7,t:"...чтобы передать все лучшее своим детям"},{id:8,t:"...чтобы понять себя самого"},{id:9,t:"...чтобы делать добро"},{id:10,t:"...чтобы жить"},{id:11,t:"...чтобы испытывать счастье"},{id:12,t:"...чтобы осуществить себя"},{id:13,t:"...чтобы сделать хорошую карьеру"},{id:14,t:"...чтобы чувствовать, что кому-то нужен"},{id:15,t:"...чтобы жить ради своей семьи"},{id:16,t:"...чтобы познавать Бога"},{id:17,t:"...чтобы улучшать мир"},{id:18,t:"...чтобы любить"},{id:19,t:"...чтобы получать как можно больше ощущений и переживаний"},{id:20,t:"...чтобы реализовать все свои возможности"},{id:21,t:"...чтобы занимать достойное положение в обществе"},{id:22,t:"...чтобы радоваться общению с другими"},{id:23,t:"...чтобы помогать своим родным и близким"},{id:24,t:"...чтобы понять жизнь"}];

const milman_qs=[
    {q:"В своем поведении в жизни нужно придерживаться следующих принципов:", i:[ "«Время - деньги». Нужно стремиться их больше зарабатывать.", "«Главное - здоровье». Нужно беречь себя и свои нервы.", "Свободное время нужно проводить с друзьями.", "Свободное время надо отдавать семье.", "Нужно делать добро, даже если это дорого обходится.", "Нужно делать все возможное, чтобы завоевать место под солнцем.", "Нужно приобретать больше знаний, чтобы понять причины и сущность того, что происходит вокруг.", "Нужно стремиться открыть что-то новое, создать, изобрести." ]},
    {q:"В своем поведении на работе нужно следовать таким принципам:", i:[ "Работа - это вынужденная жизненная необходимость.", "Главное - не допускать конфликтов.", "Нужно стремиться обеспечить себя спокойными, удобными условиями.", "Нужно активно стремится к служебному продвижению.", "Главное - завоевать авторитет и признание.", "Нужно постоянно совершенствоваться в своем деле.", "В своей работе всегда надо найти интересное, что может увлечь.", "Нужно не только увлечься самому, но и увлечь работой других." ]},
    {q:"Среди моих дел в свободное время большое место занимают следующие дела:", i:[ "Текущие, домашние.", "Отдых, развлечения.", "Встречи с друзьями.", "Общественные дела.", "Занятия с детьми.", "Учеба, чтение необходимой для работы литературы.", "Хобби.", "Подрабатывание денег." ]},
    {q:"Среди моих рабочих дел много места занимают:", i:[ "Деловое общение (переговоры, выступления, обсуждения и т. д.).", "Личное общение (на темы, не связанные с работой).", "Общественная работа.", "Учеба, получение новой информации, повышение квалификации.", "Работа творческого характера.", "Работа, непосредственно влияющая на заработок (сдельная, дополнительная).", "Работа, связанная с ответственностью перед другими.", "Свободное время, перекуры, отдых." ]},
    {q:"Если бы мне добавили выходной день, я бы скорее всего потратил его на то, чтобы:", i:[ "Заниматься текущими домашними делами.", "Отдыхать.", "Развлекаться.", "Заниматься общественной работой.", "Заниматься учебой, получением новых знаний.", "Заниматься творческой работой.", "Делать дело, в котором чувствуешь ответственность перед другими.", "Делать дело, дающее возможность заработать." ]},
    {q:"Если бы у меня была возможность по-своему планировать рабочий день, я бы стал скорее всего заниматься:", i:[ "Тем, что составляет мои основные обязанности.", "Общением с людьми по делам (переговоры, обсуждения).", "Личным общением (разговорами, не связанными с работой).", "Общественной работой.", "Учебой, получением новых знаний, повышением квалификации.", "Творческой работой.", "Работой, в которой чувствуешь пользу и ответственность.", "Работой, за которую можно больше получить." ]},
    {q:"Я часто разговариваю с друзьями и знакомыми на такие темы:", i:[ "Где что можно купить, как хорошо провести время.", "Про общих знакомых.", "О том, что вижу и слышу вокруг.", "Как добиться успеха в жизни.", "О работе.", "О своих увлечениях.", "О своих успехах и планах.", "О жизни, книгах, кинофильмах, политике." ]},
    {q:"Моя работа дает мне прежде всего:", i:[ "Достаточные материальные средства для жизни.", "Общение с людьми, дружеские отношения.", "Авторитет и уважение окружающих.", "Интересные встречи и беседы.", "Удовлетворение от работы.", "Чувство своей полезности.", "Возможность повышать свой профессиональный уровень.", "Возможность служебного продвижения." ]},
    {q:"Больше всего мне хочется бывать в таком обществе, где:", i:[ "Уютно, хорошие развлечения.", "Можно обсудить волнующие тебя рабочие темы.", "Тебя уважают, считают авторитетом.", "Можно встретиться с нужными людьми, завязать полезные связи.", "Можно приобрести новых друзей.", "Бывают известные заслуженные люди.", "Все связаны общим делом.", "Можно проявить и развить свои способности." ]},
    {q:"Я хотел бы на работе быть рядом с такими людьми:", i:[ "С которыми можно поговорить на разные темы.", "Которым мог бы передавать свой опыт и знания.", "С которыми можно больше заработать.", "Которые имеют авторитет и вес на работе.", "Которые могут научить чему-нибудь полезному.", "Которые заставляют тебя становиться активнее на работе.", "Которые имеют много знаний и интересных идей.", "Которые готовы поддержать тебя в разных ситуациях." ]},
    {q:"К настоящему времени я имею в достаточной степени:", i:[ "Материальное благополучие.", "Возможность интересно развлекаться.", "Хорошие условия жизни.", "Хорошую семью.", "Достаточно возможностей интересно проводить время в обществе.", "Уважение, признание и благодарность других.", "Чувство полезности для других.", "Создание чего-то ценного, полезного." ]},
    {q:"Я думаю, что имею в своей работе в достаточной степени:", i:[ "Хорошую зарплату, другие материальные блага.", "Хорошие условия для работы.", "Хороший коллектив, дружеские взаимоотношения.", "Определенные творческие достижения.", "Хорошую должность.", "Самостоятельность и независимость.", "Авторитет и уважение коллег.", "Достаточно высокий профессиональный уровень." ]},
    {q:"Больше всего мне нравится, когда:", i:[ "Не нужно думать о насущных заботах.", "Есть комфортное, приятное окружение.", "Кругом оживление, веселая суета.", "Предстоит провести время в веселом обществе.", "Испытываю чувство соревнования, поиска.", "Испытываю чувство активного напряжения и ответственности.", "Погружен в свою работу.", "Включен в совместную работу с другими." ]},
    {q:"Когда меня постигает неудача, не получается то, что я хочу:", i:[ "Я расстраиваюсь и долго переживаю.", "Стараюсь переключиться на что-нибудь другое, приятное.", "Теряюсь, не знаю что делать, злюсь на себя.", "Злюсь на то, что мне помешало.", "Стараюсь оставаться спокойным, и обычно мне это удается.", "Пережидаю, когда пройдет первая реакция, и спокойно анализирую, что произошло.", "Стараюсь понять, в чем я сам был виноват.", "Стараюсь понять причины неудачи и поправить положение." ]}
];

const ipl_qs=[
    "Все знания о мире можно легко получить из книг, компьютерной сети.", "Когда я думаю о будущем, не чувствую страха за свою семью, страну, где я живу.", "Я смог бы побороть страх за свою безопасность и заняться экстремальным видом спорта, прыгнуть с парашютом, нырнуть с аквалангом.", "Я без усилий переключаюсь на рабочий режим после продолжительных праздников или отпуска.", "Продвижение по социальной и профессиональной лестнице – главная причина, по которой я стараюсь овладеть новой информацией, даже если она для меня не интересна.", "Происходящие со мной перемены не вызывают у меня чувства тревоги или беспокойства.", "Рядовой человек не несет ответственности за возникновение озоновых дыр, глобальное загрязнение природной среды и прочие подобные катаклизмы.", "Когда я иду по хорошо знакомой дороге, то сразу подмечаю произошедшие вокруг перемены.", "Любые изменения в социально-политической ситуации приводят к очередному кризису.", "Я - представитель консервативной профессии, поэтому чьи-либо попытки внести изменения в организацию моей работы, только вредят делу.", "Я легко нахожу язык с новым человеком, веду себя как обычно в кругу незнакомых людей.", "Я не придаю особого значения постоянному месту отдыха, питанию.", "Я регулярно и с интересом читаю книги «альтернативных авторов», слушаю новые, необычные виды музыки, посещаю выставки, театр.", "В современном мире, точно как в пословице – много нового, мало хорошего.", "Обычно мне трудно взяться за новое дело.", "Культурным вполне можно назвать того человека, который имеет высшее образование.", "Если требования начальника противоречат моим моральным или нравственным нормам, я без колебаний сменю место работы, даже если она престижна и очень хорошо оплачиваема.", "Большинство людей живет интересной, насыщенной жизнью.", "Я стараюсь прислушиваться к природному ритму мира.", "Для меня очень важно соблюдать принятые в моей среде правила.", "Для того, чтобы разобраться в сути чего-либо, недостаточно спросить об этом у специалистов.", "Хороший друг никогда не изменит свои симпатии и расположение ко мне.", "Я с интересом, непредвзято и без скептицизма отношусь к культурным традициям самых разных национальностей.", "Жизненные, финансовые обстоятельства не позволяют мне в последнее время следить за новой литературой по моей специальности.", "Лучше жить в стабильных, предсказуемых условиях, даже если они не очень хорошие.", "Я с трудом привыкаю к новому коллективу, работе, месту отдыха.", "Я скептически отношусь ко всякого рода нововведениям, нетрадиционным подходам в живописи, кино, театральных постановках.", "Я все чаще задумываюсь над тем, что время быстротечно и безжалостно.", "Меня радуют те изменения, которые произошли в моей жизни за последнее время.", "Меня не пугает перспектива внезапной необходимости самостоятельно освоить новую сферу знаний.", "Изменить стиль работы, однажды выбранную специальность, образ жизни людей вынуждает необходимость.", "Для того, чтобы без ошибок ориентироваться в политической ситуации совсем не обязательно следить за сменой правительства, и дополнениями к конституции.", "Неожиданные изменения в распорядке дня вызывают у меня раздражение.", "Обычно я легко меняю принятое решение, учитывая разумные аргументы других.", "Я без труда ориентируясь на незнакомой местности.", "Мне всегда достаточно собственных сил, чтобы обратить неблагоприятные обстоятельства на свою пользу."
];

// Состояние
let state = { meta: {}, bratus: {}, rank: 1, milman: {}, ipl: {} };
let anonMode = false;

// --- PERSISTENCE ---
function saveStateToLocal() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); updateProgress(); }
function loadStateFromLocal() {
    let saved = localStorage.getItem(STORAGE_KEY);
    if (saved) Object.assign(state, JSON.parse(saved));
}
function clearState() { localStorage.removeItem(STORAGE_KEY); window.location.reload(); }

// INIT
window.onload = function() {
    if (localStorage.getItem(STORAGE_KEY)) {
        loadStateFromLocal();
        if (state.finished) {
            finishSurvey(true);
        } else if (Object.keys(state.ipl).length > 0) {
            switchStep('step-form', 'step-ipl'); renderIPL();
        } else if (Object.keys(state.milman).length > 0) {
            switchStep('step-form', 'step-milman'); renderMilman();
        } else if (state.rank > 1 || (state.bratus && Object.keys(state.bratus).length > 0)) {
            switchStep('step-form', 'step-bratus'); renderBratus();
        } else if (state.meta.fio) {
            restoreForm();
        }
    }
};

function restoreForm() {
    if (state.meta.mode === 'anon' || state.meta.fio === "Аноним") {
        document.getElementById('anon_mode').checked = true;
        toggleAnon();
    }
    for(let k in state.meta) { let el = document.getElementById(k); if(el) el.value = state.meta[k]; }
    toggleWorkPlace(); toggleEduBlock();
}

function updateProgress() {
    let current = 0;
    if (document.getElementById('step-bratus').classList.contains('active')) current = state.rank;
    else if (document.getElementById('step-milman').classList.contains('active')) current = 9;
    else if (document.getElementById('step-ipl').classList.contains('active')) current = 10;
    else if (document.getElementById('step-results').classList.contains('active')) current = 11;
    
    let pct = Math.min(100, (current / 11) * 100);
    document.querySelector('.progress-fill').style.width = pct + "%";
}

// --- GOD MODE (DEV) ---
function checkDevMode(val) {
    if(val.toLowerCase().trim() === 'dev') {
        document.getElementById('dev-panel').style.display = 'block';
    }
}

function fillRandomData() {
    state.meta = { fio: "Тестовый Юзер", gender: "Мужской", age: "25", family_status: "Холост/Не замужем", children: "Нет", is_working: "Да", work_place: "IT", has_secondary_edu: "Нет", edu_status: "Учусь", university: "СурГУ", speciality: "Психология", edu_level: "Бакалавриат", edu_basis: "Бюджет", course: "4", mode: "dev" };
    
    let ids = Array.from({length:24}, (_, i) => i + 1);
    for(let r=1; r<=8; r++) {
        state.bratus[r] = [];
        for(let k=0; k<3; k++) {
            let randIdx = Math.floor(Math.random() * ids.length);
            state.bratus[r].push(ids[randIdx]);
            ids.splice(randIdx, 1);
        }
    }
    state.rank = 8;
    for(let q=0; q<14; q++) for(let i=0; i<8; i++) state.milman[`${q}_${i}`] = Math.floor(Math.random() * 4);
    for(let i=0; i<36; i++) state.ipl[i] = Math.floor(Math.random() * 5) + 1;
    
    saveStateToLocal();
    finishSurvey();
}

function loadDevJSON() {
    try {
        let json = document.getElementById('dev-json-input').value;
        let data = JSON.parse(json);
        if(data.bratus && data.milman && data.ipl) {
            state = data;
            state.meta.mode = "dev"; // Force dev to avoid pollution
            saveStateToLocal();
            finishSurvey(true);
        } else {
            alert("Некорректный JSON (нет полей bratus/milman/ipl)");
        }
    } catch(e) {
        document.getElementById('dev-error').innerText = "Ошибка парсинга: " + e.message;
    }
}

// --- ЛОГИКА ---
function toggleAnon() {
    anonMode = document.getElementById('anon_mode').checked;
    state.meta.mode = anonMode ? 'anon' : 'normal';
    document.getElementById('anon_warning').style.display = anonMode ? 'block' : 'none';
    document.querySelectorAll('.req').forEach(el => el.style.display = anonMode ? 'none' : 'inline');
    const inputs = document.querySelectorAll('#step-form input:not(#anon_mode), #step-form select');
    inputs.forEach(el => el.style.backgroundColor = anonMode ? '#f9f9f9' : '#fff');
    saveStateToLocal();
}

function toggleWorkPlace() { document.getElementById('work_place_block').style.display = (document.getElementById('is_working').value === "Да") ? 'block' : 'none'; }
function toggleEduBlock() {
    const status = document.getElementById('edu_status').value;
    document.getElementById('edu_block').style.display = (status === "Учусь" || status === "Закончил") ? 'block' : 'none';
    document.getElementById('course_block').style.display = (status === "Учусь") ? 'block' : 'none';
}

function validateForm() {
    let ids = ['fio','gender','age','family_status','children','is_working','has_secondary_edu','edu_status'];
    const status = document.getElementById('edu_status').value;
    if(status === 'Учусь') ids = ids.concat(['university','speciality','edu_level','edu_basis','course']);
    else if(status === 'Закончил') ids = ids.concat(['university','speciality','edu_level','edu_basis']);
    
    let valid = true;
    anonMode = document.getElementById('anon_mode').checked;
    
    if (!anonMode) {
        ids.forEach(id => {
            let el = document.getElementById(id);
            if(!el || !el.value) { if(el) el.style.borderColor = "var(--error)"; valid = false; } 
            else { if(el) el.style.borderColor = "#ddd"; state.meta[id] = el.value; }
        });
    } else {
        ids.forEach(id => { state.meta[id] = "Аноним"; });
    }
    if(!valid) { document.getElementById('form-error').style.display = 'block'; return; }
    
    saveStateToLocal();
    switchStep('step-form', 'step-bratus');
    renderBratus();
}

function renderBratus() {
    const c = document.getElementById('bratus-options'); c.innerHTML = "";
    document.getElementById('bratus-sub').innerHTML = `Выберите <b>3</b> утверждения для <b>${state.rank}-го места</b>`;
    
    let used = []; 
    for(let k in state.bratus) if(parseInt(k) !== state.rank) used = used.concat(state.bratus[k]);
    
    bratus_stmts.forEach(s => {
        if(!used.includes(s.id)) {
            let div = document.createElement('div'); div.className = 'option-card'; div.innerHTML = `<input type="checkbox" value="${s.id}"> ${s.t}`;
            if(state.bratus[state.rank] && state.bratus[state.rank].includes(s.id)) { div.classList.add('checked'); div.querySelector('input').checked = true; }
            div.onclick = (e) => { 
                if(e.target.tagName!=='INPUT') div.querySelector('input').click(); 
                div.classList.toggle('checked', div.querySelector('input').checked); 
                saveStateToLocal();
            };
            div.querySelector('input').onchange = () => saveStateToLocal();
            c.appendChild(div);
        }
    });
    updateProgress();
}
function nextBratusRank() {
    const ch = document.querySelectorAll('#bratus-options input:checked');
    if(ch.length !== 3) { document.getElementById('bratus-error').style.display = 'block'; return; }
    document.getElementById('bratus-error').style.display = 'none';
    state.bratus[state.rank] = Array.from(ch).map(i => parseInt(i.value));
    saveStateToLocal();
    if(state.rank < 8) { state.rank++; renderBratus(); window.scrollTo(0,0); }
    else { switchStep('step-bratus', 'step-milman'); renderMilman(); }
}
function prevBratusRank() { if(state.rank > 1) { state.rank--; renderBratus(); } else switchStep('step-bratus', 'step-form'); saveStateToLocal(); }

function renderMilman() {
    const c = document.getElementById('milman-container');
    document.getElementById('progress').style.width = "60%"; 
    if(c.innerHTML) {
        for(let k in state.milman) { 
            let el = document.querySelector(`input[name="m_${k}"][value="${state.milman[k]}"]`); 
            if(el) el.checked = true; 
        }
        return; 
    }
    
    milman_qs.forEach((q, qi) => {
        let h = `<div class="q-block"><h3>${qi+1}. ${q.q}</h3><table><thead><tr><th>Утверждение</th><th>++ (Да, согласен)</th><th>+ (Пожалуй согласен)</th><th>= (Когда как)</th><th>- / ? (Нет / Не знаю)</th></tr></thead><tbody>`;
        q.i.forEach((txt, ii) => {
            let nm = `m_${qi}_${ii}`;
            h += `<tr id="row_${nm}"><td>${txt}</td>
            <td data-label="++ (Да)"><input type="radio" name="${nm}" value="3" onclick="saveM('${nm}',3)"></td>
            <td data-label="+ (Пожалуй)"><input type="radio" name="${nm}" value="2" onclick="saveM('${nm}',2)"></td>
            <td data-label="= (Когда как)"><input type="radio" name="${nm}" value="1" onclick="saveM('${nm}',1)"></td>
            <td data-label="- / ? (Нет)"><input type="radio" name="${nm}" value="0" onclick="saveM('${nm}',0)"></td></tr>`;
        });
        c.innerHTML += h + "</tbody></table></div>";
    });
    for(let k in state.milman) { 
        let el = document.querySelector(`input[name="m_${k}"][value="${state.milman[k]}"]`); 
        if(el) el.checked = true; 
    }
    updateProgress();
}
function saveM(k, v) { state.milman[k.replace('m_','')] = v; document.getElementById('row_'+k).classList.remove('highlight-error'); saveStateToLocal(); }
function finishMilman() {
    if(!validateGroup('m', 14, 8)) return;
    switchStep('step-milman', 'step-ipl');
    renderIPL();
}
function prevMilman() { switchStep('step-milman', 'step-bratus'); saveStateToLocal(); }

function renderIPL() {
    const c = document.getElementById('ipl-container');
    if(c.innerHTML) {
        for(let k in state.ipl) { 
            let el = document.querySelector(`input[name="ipl_${k}"][value="${state.ipl[k]}"]`); 
            if(el) el.checked = true; 
        }
        return;
    }
    let h = `<table><thead><tr><th>Утверждение</th><th>1 (Не согласен)</th><th>2</th><th>3</th><th>4</th><th>5 (Согласен)</th></tr></thead><tbody>`;
    ipl_qs.forEach((txt, i) => {
        let nm = `ipl_${i}`;
        h += `<tr id="row_${nm}"><td>${i+1}. ${txt}</td>${[1,2,3,4,5].map(v => `<td data-label="${v}"><input type="radio" name="${nm}" value="${v}" onclick="saveI(${i},${v})"></td>`).join('')}</tr>`;
    });
    c.innerHTML = h + "</tbody></table>";
    for(let k in state.ipl) { 
        let el = document.querySelector(`input[name="ipl_${k}"][value="${state.ipl[k]}"]`); 
        if(el) el.checked = true; 
    }
    updateProgress();
}
function saveI(i, v) { state.ipl[i] = v; document.getElementById('row_ipl_'+i).classList.remove('highlight-error'); saveStateToLocal(); }
function prevIPL() { switchStep('step-ipl', 'step-milman'); saveStateToLocal(); }

// --- ФИНАЛ ---
function finishSurvey(skipFetch = false) {
    if(!skipFetch && !validateGroup('ipl', 36, 1)) return;
    
    state.finished = true; 
    saveStateToLocal();
    updateProgress();

    if(skipFetch) {
        switchStep('step-ipl', 'step-results'); 
        switchStep('step-form', 'step-results'); 
        calculateAndShowResults(true);
        return;
    }

    switchStep('step-ipl', 'step-loading');
    
    const isDev = state.meta.mode === 'dev';

    if (!isDev) {
        fetch(GOOGLE_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(state) })
        .then(() => { document.getElementById('final-msg').innerHTML = "Данные успешно <b style='color:green'>сохранены в облаке</b>."; })
        .catch(() => { document.getElementById('final-msg').innerHTML = "<b style='color:red'>Ошибка отправки!</b> Обязательно сохраните файл."; });
    } else {
        console.log("DEV MODE: Отправка заблокирована.");
        document.getElementById('final-msg').innerHTML = "<b style='color:orange'>[РЕЖИМ РАЗРАБОТЧИКА]</b> Отправка в облако отключена.";
    }

    calculateAndShowResults();
}

function calculateAndShowResults(immediate = false) {
    // 1. БРАТУСЬ
    const cats_map = { 'Альтруистические': [1,9,17], 'Экзистенциальные': [2,10,18], 'Гедонистические': [3,11,19], 'Самореализации': [4,12,20], 'Статусные': [5,13,21], 'Коммуникативные': [6,14,22], 'Семейные': [7,15,23], 'Когнитивные': [8,16,24] };
    let b_labels=[], b_data=[], b_desc="";
    let id_to_rank = {}; for(let r in state.bratus) state.bratus[r].forEach(id => id_to_rank[id] = parseInt(r));
    for(let c in cats_map) { 
        let sum = 0; cats_map[c].forEach(id => sum += (id_to_rank[id] || 0)); 
        b_labels.push(c); b_data.push(sum);
        let status = sum <= 9 ? "<span style='color:green'>Доминируют</span>" : (sum <= 17 ? "Представлены достаточно" : "<span style='color:red'>Представлены слабо</span>");
        b_desc += `<div><b>${c}:</b> ${sum} (${status})</div>`;
    }

    // 2. МИЛЬМАН
    const m_keys = [ ['P','P','O','D','OD','S','DR','DR'], ['P','K','K','S','S','DR','DR','OD'], ['P','K','O','OD','OD','-','D','P'], ['D','O','OD','D','DR','P','OD','K'], ['P','K','K','OD','DR','DR','OD','P'], ['D','D','O','S','-','DR','OD','P'], ['K','O','S','S','P','DR','DR','O'], ['P','O','S','O','DR','OD','DR','S'], ['K','D','S','S','O','S','D','K'], ['O','OD','P','S','P','OD','DR','-'], ['P','K','K','O','S','S','OD','DR'], ['P','K','K','DR','S','S','OD','P'], ['ast','ast','ast','ast','st','st','st','st'], ['ast','ast','ast','ast','st','st','st','st'] ];
    const sub_map = { 0:'id', 4:'id', 8:'id', 1:'id', 5:'id', 9:'id', 2:'re', 6:'re', 10:'re', 3:'re', 7:'re', 11:'re' };
    let m_scores = { 'id': {'P':0,'K':0,'S':0,'O':0,'D':0,'DR':0,'OD':0}, 're': {'P':0,'K':0,'S':0,'O':0,'D':0,'DR':0,'OD':0} };
    
    // Эмоциональный профиль
    let emo = { st:0, ast:0, fst:0, fast:0 };

    for(let q=0; q<14; q++) { 
        if (q < 12) { // Мотивация
            let type = sub_map[q]; 
            for(let i=0; i<8; i++) { 
                let val = state.milman[`${q}_${i}`] || 0; 
                let scale = m_keys[q][i]; 
                if(scale !== '-' && m_scores[type][scale] !== undefined) m_scores[type][scale] += val; 
            }
        } else { // Эмоции (13, 14)
            for(let i=0; i<8; i++) {
                let val = state.milman[`${q}_${i}`] || 0;
                let scale = m_keys[q][i]; // 'st' или 'ast'
                if(q === 12) emo[scale] += val;
                if(q === 13) scale === 'st' ? emo.fst += val : emo.fast += val;
            }
        }
    }
    
    // Тип профиля Мильмана
    let sum_maintain = m_scores['id']['P'] + m_scores['id']['K'] + m_scores['id']['S']; 
    let sum_develop = m_scores['id']['D'] + m_scores['id']['DR'] + m_scores['id']['OD'];
    let m_type = (sum_develop - sum_maintain >= 5) ? "<span class='score-badge bg-green'>Прогрессивный</span> (развитие преобладает)" : (sum_maintain > sum_develop ? "<span class='score-badge bg-red'>Регрессивный</span> (потребление преобладает)" : "<span class='score-badge bg-blue'>Импульсивный/Смешанный</span>");

    // Тип Эмоциональный
    let emo_type = (emo.st > emo.ast) ? "<span class='score-badge bg-green'>Стенический</span> (активность, устойчивость)" : "<span class='score-badge bg-red'>Астенический</span> (тревожность, неустойчивость)";

    const scales_order = ['P','K','S','O','D','DR','OD'];
    const scales_names = ['Жизнеобеспечение','Комфорт','Социальный статус','Общение','Общая активность','Творческая активность','Общественная польза'];
    let data_id = scales_order.map(s => m_scores['id'][s]);
    let data_re = scales_order.map(s => m_scores['re'][s]);

    // 3. ИПЛ
    let ipl_sum = 0;
    let rev_idx = [0, 4, 6, 8, 9, 13, 14, 15, 19, 21, 23, 24, 25, 26, 27, 30, 31, 32];
    for(let i=0; i<36; i++) { let val = state.ipl[i]; if(rev_idx.includes(i)) val = 6 - val; ipl_sum += val; }

    setTimeout(() => {
        if(!immediate) switchStep('step-loading', 'step-results');
        
        document.getElementById('result-area').value = JSON.stringify(state, null, 2);

        if(window.chartB) window.chartB.destroy();
        window.chartB = new Chart(document.getElementById('chartBratus').getContext('2d'), {
            type: 'bar', data: { labels: b_labels, datasets: [{ label: 'Сумма рангов (Меньше = Важнее)', data: b_data, backgroundColor: '#3498db' }] },
            options: { scales: { y: { reverse: true, min: 0, max: 25 } } }
        });
        document.getElementById('textBratus').innerHTML = b_desc;
        
        if(window.chartM) window.chartM.destroy();
        window.chartM = new Chart(document.getElementById('chartMilman').getContext('2d'), {
            type: 'line', data: { labels: scales_names, datasets: [ { label: 'Желаемое (Идеал)', data: data_id, borderColor: '#27ae60', backgroundColor: 'rgba(39,174,96,0.1)', fill: true }, { label: 'Текущее (Реал)', data: data_re, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: true } ] },
            options: { scales: { y: { min: 0 } } }
        });
        document.getElementById('textMilman').innerHTML = `
            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <div><b>Тип мотивационного профиля:</b> ${m_type}</div>
                <div><b>Тип эмоционального профиля:</b> ${emo_type}</div>
            </div>
        `;

        let ipl_level = ipl_sum >= 118 ? "Высокий" : (ipl_sum >= 95 ? "Средний" : "Низкий");
        let ipl_cls = ipl_sum >= 118 ? "bg-green" : (ipl_sum >= 95 ? "bg-blue" : "bg-red");
        let ipl_text = ipl_sum >= 118 ? "<b>Инициативно-преобразовательный тип.</b> Вы открыты новому, легко адаптируетесь к переменам и готовы к риску." : (ipl_sum >= 95 ? "<b>Позитивно-дифференцированный тип.</b> Вы взвешенно подходите к инновациям, принимая их, когда видите практическую пользу." : "<b>Вынужденно-приспособительный тип.</b> Вы цените стабильность и традиции, перемены могут вызывать у вас дискомфорт.");

        document.getElementById('textIPL').innerHTML = `
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <div style="font-size:2.5em; font-weight:bold; color:#2c3e50;">${ipl_sum}</div>
                <div><span class="score-badge ${ipl_cls}" style="font-size:1.1em;">Уровень: ${ipl_level}</span></div>
            </div>
            <p>${ipl_text}</p>
        `;
    }, immediate ? 0 : 1000);
}

// Утилиты
function switchStep(f, t) { document.getElementById(f).classList.remove('active'); setTimeout(() => document.getElementById(t).classList.add('active'), 200); window.scrollTo(0,0); updateProgress(); }
function downloadJSON() { const fn = `Res_${state.meta.fio.replace(/[^а-яА-Яa-zA-Z0-9]/g,'_')}.json`; const blob = new Blob([JSON.stringify(state, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fn; document.body.appendChild(a); a.click(); a.remove(); }
function copyResult() { 
    let txt = document.getElementById('result-area'); 
    txt.style.display = 'block'; 
    txt.select(); 
    document.execCommand('copy'); 
    document.getElementById('copy-msg').style.display = 'block'; 
}
function validateGroup(prefix, c1, c2) {
    let err = null; let cont = prefix==='m'?state.milman:state.ipl;
    if(c2===1) { for(let i=0;i<c1;i++) if(!cont[i]) { err=document.getElementById('row_ipl_'+i); err.classList.add('highlight-error'); break; } }
    else { for(let q=0;q<c1;q++) for(let i=0;i<c2;i++) if(cont[`${q}_${i}`]===undefined) { err=document.getElementById(`row_m_${q}_${i}`); err.classList.add('highlight-error'); break; } }
    if(err) { err.scrollIntoView({behavior:"smooth", block:"center"}); document.getElementById(prefix==='m'?'milman-error':'ipl-error').style.display='block'; return false; }
    return true;
}
</script>